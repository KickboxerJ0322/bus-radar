<!DOCTYPE html> 
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バスレーダー</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map-container {
            position: relative;
            display: inline-block;
        }
        
        #map {
            top: 32px; /* 外枠に隣接するように調整 */
            height: 500px;
            width: 500px; /* 地図の幅と高さを同じにすることで円形を確実にします */
            border-radius: 50%; /* 丸い形にする */
            overflow: hidden; /* 地図の境界からはみ出る部分を隠す */
            border: 30px solid transparent;
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.4), /* 地図全体の下に落ちる影 */
                        inset 0 10px 15px rgba(255, 255, 255, 0.5), /* 内側の光の反射による効果 */
                        inset 0 -10px 20px rgba(0, 0, 0, 0.3); /* 下側の内側の影で立体感を強調 */
            position: relative;
        }

        #north-rectangle1 {
            position: absolute;
            top: 0px; /* 外枠に隣接するように調整 */
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 15px;
            background-color: #f1ebebc9; /* 外枠と同じ色の四角形 */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3); /* 立体感を追加する影 */
            background: linear-gradient(to bottom right, #f1ebebc9, rgba(0, 0, 0, 0.2)); /* 左上が明るく右下がもっと暗くなるグラデーションを追加 */
        }

        #north-rectangle2 {
            position: absolute;
            top: 15px; /* 外枠に隣接するように調整 */
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 10px;
            background-color: #f1ebebc9; /* 外枠と同じ色の四角形 */
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.3); /* 立体感を追加する影 */
            background: linear-gradient(to bottom right, #f1ebebc9, rgba(0, 0, 0, 0.2)); /* 左上が明るく右下がもっと暗くなるグラデーションを追加 */
        }        

        #north-rectangle3 {
            position: absolute;
            top: 25px; /* 外枠に隣接するように調整 */
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 10px;
            background-color: #f1ebebc9; /* 外枠と同じ色の四角形 */
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.3); /* 立体感を追加する影 */
            background: linear-gradient(to bottom right, #f1ebebc9, rgba(0, 0, 0, 0.2)); /* 左上が明るく右下がもっと暗くなるグラデーションを追加 */
        }       

        header {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            text-align: left;
            font-weight: bold;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        .station-icon {
            background-color: transparent;
            width: 20px;
            height: 20px;
            border-radius: 5px;
            border: 2px solid gray; /* 濃い灰色に修正 */
        }
    </style>
</head>
<body>
    <header>
        バスレーダー＜きよバス＞
    </header>
    <div id="map-container">
        <div id="north-rectangle1"></div>
        <div id="north-rectangle2"></div>
        <div id="north-rectangle3"></div>
        <div id="map"></div>
    </div>
    <div>
        <br />
        <p>データ反映日時: <span id="timestamp">更新中...</span></p>
        <button id="getCurrentLocationButton">現在位置</button>
        <button id="refreshButton">データを更新</button>
        <button id="updateEvery20sButton">20秒ごとに9回更新</button>
        <button id="clearDataMarkersButton">マーカーの削除</button>
        <button id="showStationsButton">バス停を表示</button>
        <button id="clearStationMarkersButton">バス停を削除</button>
        <button id="transitAlertButton">運行情報</button>
        <button id="routeUpdateButton">ルート更新情報</button>
    </div>
    <div>
        <input type="text" id="vehicleIdInput" placeholder="Enter Vehicle ID">
        <button id="startButton">実行</button>
        <button id="clearExecutionMarkersButton">実行を削除</button>
    </div>
    <div>
        <h3>データを更新ボタンの結果</h3>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Alphabet ID</th>
                    <th>Vehicle ID</th>
                    <th>Latitude (1回目)</th>
                    <th>Longitude (1回目)</th>
                    <th>Readable Date (1回目)</th>
                    <th>Destination (1回目)</th>
                    <th>Latitude (2回目)</th>
                    <th>Longitude (2回目)</th>
                    <th>Readable Date (2回目)</th>
                    <th>Destination (2回目)</th>
                    <th>Latitude (3回目)</th>
                    <th>Longitude (3回目)</th>
                    <th>Readable Date (3回目)</th>
                    <th>Destination (3回目)</th>
                    <th>Latitude (4回目)</th>
                    <th>Longitude (4回目)</th>
                    <th>Readable Date (4回目)</th>
                    <th>Destination (4回目)</th>
                    <th>Latitude (5回目)</th>
                    <th>Longitude (5回目)</th>
                    <th>Readable Date (5回目)</th>
                    <th>Destination (5回目)</th>
                    <th>Latitude (6回目)</th>
                    <th>Longitude (6回目)</th>
                    <th>Readable Date (6回目)</th>
                    <th>Destination (6回目)</th>
                    <th>Latitude (7回目)</th>
                    <th>Longitude (7回目)</th>
                    <th>Readable Date (7回目)</th>
                    <th>Destination (7回目)</th>
                    <th>Latitude (8回目)</th>
                    <th>Longitude (8回目)</th>
                    <th>Readable Date (8回目)</th>
                    <th>Destination (8回目)</th>
                    <th>Latitude (9回目)</th>
                    <th>Longitude (9回目)</th>
                    <th>Readable Date (9回目)</th>
                    <th>Destination (9回目)</th>
                </tr>
            </thead>
            <tbody>
                <!-- データはここに追加されます（最大20行） -->
            </tbody>
        </table>
    </div>
    <div>
        <h3>実行ボタンの結果</h3>
        <table id="executionTable">
            <thead>
                <tr>
                    <th>Vehicle ID</th>
                    <th>Latitude (1回目)</th>
                    <th>Longitude (1回目)</th>
                    <th>Readable Date (1回目)</th>
                    <th>Destination (1回目)</th>
                    <th>Latitude (2回目)</th>
                    <th>Longitude (2回目)</th>
                    <th>Readable Date (2回目)</th>
                    <th>Destination (2回目)</th>
                    <th>Latitude (3回目)</th>
                    <th>Longitude (3回目)</th>
                    <th>Readable Date (3回目)</th>
                    <th>Destination (3回目)</th>
                    <th>Latitude (4回目)</th>
                    <th>Longitude (4回目)</th>
                    <th>Readable Date (4回目)</th>
                    <th>Destination (4回目)</th>
                    <th>Latitude (5回目)</th>
                    <th>Longitude (5回目)</th>
                    <th>Readable Date (5回目)</th>
                    <th>Destination (5回目)</th>
                    <th>Latitude (6回目)</th>
                    <th>Longitude (6回目)</th>
                    <th>Readable Date (6回目)</th>
                    <th>Destination (6回目)</th>
                    <th>Latitude (7回目)</th>
                    <th>Longitude (7回目)</th>
                    <th>Readable Date (7回目)</th>
                    <th>Destination (7回目)</th>
                    <th>Latitude (8回目)</th>
                    <th>Longitude (8回目)</th>
                    <th>Readable Date (8回目)</th>
                    <th>Destination (8回目)</th>
                    <th>Latitude (9回目)</th>
                    <th>Longitude (9回目)</th>
                    <th>Readable Date (9回目)</th>
                    <th>Destination (9回目)</th>
                </tr>
            </thead>
            <tbody>
                <!-- データはここに追加されます -->
            </tbody>
        </table>
    </div>
    <!-- 運行情報とルート更新情報を表示するための新しいdiv要素を追加 -->
    <div>
        <h3>運行情報</h3>
        <div id="alertInfo"></div>
    </div>
    <div>
        <h3>ルート更新情報</h3>
        <div id="routeUpdateInfo"></div>
    </div>
    <script>
        // 新しい関数を追加
        async function fetchTransitInfo(action) {
            const url = `https://script.google.com/macros/s/AKfycbxyj7UGAD8uakopVpyk0LkAPs7IwsvCCw83gMuhUbfGH6xXezQButvvlIJeMdnfdzQlzw/exec?action=${action}`;
            try {
                const response = await fetch(url);
                if (response.ok) {
                    return await response.json();
                } else {
                    console.error('Request failed');
                    return null;
                }
            } catch (error) {
                console.error('Error:', error);
                return null;
            }
        }

        function displayTransitInfo(data, elementId) {
            const container = document.getElementById(elementId);
            if (!data) {
                container.innerHTML = '<p>情報の取得に失敗しました。</p>';
                return;
            }
            
            // データを整形して表示
            let html = '<table><thead><tr>';
            // ヘッダーの作成
            if (data.length > 0) {
                for (let key in data[0]) {
                    html += `<th>${key}</th>`;
                }
            }
            html += '</tr></thead><tbody>';
            
            // データ行の作成
            data.forEach(item => {
                html += '<tr>';
                for (let key in item) {
                    html += `<td>${item[key]}</td>`;
                }
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            container.innerHTML = html;
        }

        async function getApiData() {
            const response = await fetch('https://script.google.com/macros/s/AKfycbxyj7UGAD8uakopVpyk0LkAPs7IwsvCCw83gMuhUbfGH6xXezQButvvlIJeMdnfdzQlzw/exec?action=getApiData');
            if (!response.ok) {
                console.error("Failed to fetch API data from GAS");
                return;
            }
            return await response.json();
        }

        let userLocationMarker;

        // グローバルスコープで map 変数を定義
        let map;

        async function initialize() {
            const apiData = await getApiData();
            if (!apiData) return;

            const sheetId = apiData.sheetId;
            const range = apiData.range;
            const apiKey = apiData.apiKey;

            const map = L.map('map').setView([35.77223, 139.52046], 15);  // 清瀬駅北口を中心に表示

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            let userLocationMarker;

            // ユーザーの位置情報を取得し、地図の中心に設定し、マーカーを表示する関数
            function getCurrentLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        const { latitude, longitude } = position.coords;

                        // 地図の中心をユーザーの現在位置に設定
                        map.setView([latitude, longitude], 15);

                        // 既存のマーカーがあれば削除
                        if (userLocationMarker) {
                            map.removeLayer(userLocationMarker);
                        }

                        // 赤い三角形のアイコンを作成
                        const triangleIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid red;"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 20]
                        });

                        // ユーザーの現在位置にマーカーを追加
                        userLocationMarker = L.marker([latitude, longitude], { icon: triangleIcon }).addTo(map)
                            .bindPopup("現在位置");
                    }, () => {
                        alert('位置情報を取得できませんでした。');
                    });
                } else {
                    alert('このブラウザでは位置情報の取得がサポートされていません。');
                }
            }

            // 現在位置ボタンのイベントリスナーを追加
            document.getElementById('getCurrentLocationButton').addEventListener('click', getCurrentLocation);

        let markers = {};  // データを更新ボタン用のマーカー
        let executionMarkers = {};  // 実行ボタン用のマーカー
        let stationMarkers = [];  // バス停のマーカー
        const executionColors = ["blue", "red", "green", "orange", "purple", "cyan"];
        const alphabetColors = [
            "yellow", "green", "blue", "orange", "purple", "cyan", "magenta", "darkcyan",
            "black", "brown", "pink", "lime", "navy", "teal", "maroon", "olive",
            "aqua", "fuchsia", "gray", "silver", "gold", "chocolate", "coral", "darkcyan",
            "darkorange", "darkgreen"
        ];
        const alphabetIDs = [];
        for (let i = 0; i < 500; i++) {
            let id = String.fromCharCode(97 + (i % 26));
            let prefix = Math.floor(i / 26);
            alphabetIDs.push(prefix ? String.fromCharCode(96 + prefix) + id : id);
        }

        async function fetchSheetData(range) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
            const response = await fetch(url);
            if (!response.ok) {
                console.error("Failed to fetch data from Google Sheets");
                return null;
            }
            const data = await response.json();
            return data.values || [];
        }

        const stationsSheetName = 'stations'; // バス停データ用のシート名
        const stationRange = `${stationsSheetName}!A2:C500`; // バス停データの範囲を指定（A列はname、B列はlat、C列はlng）
    
        // Google Sheetsからバス停データを取得する関数
        async function fetchStationData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${stationRange}?key=${apiKey}`;
            const response = await fetch(url);
            if (!response.ok) {
                console.error("Google Sheetsからバス停データを取得できませんでした");
                return null;
            }
            const data = await response.json();
            return data.values || []; // データが存在しない場合は空配列を返す
        }
    
        // バス停のデータを取得してマーカーを表示する関数
        async function showStations() {
            const stationData = await fetchStationData();
            if (!stationData) return;
    
            // 既存のバス停マーカーをすべて削除
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
    
            // バス停のデータを地図に追加
            stationData.forEach(station => {
                const [name, lat, lng] = station;
                const marker = L.marker([parseFloat(lat), parseFloat(lng)], {
                    icon: createStationIcon(),
                }).addTo(map)
                  .bindPopup(name);
    
                stationMarkers.push(marker);
            });
        }
    
        // バス停表示ボタンのイベントリスナーを設定
        document.getElementById('showStationsButton').addEventListener('click', showStations);
    
        // バス停削除ボタンのイベントリスナーを設定
        document.getElementById('clearStationMarkersButton').addEventListener('click', () => {
            // バス停マーカーをすべて削除
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
        });

        function createTrainIcon(label, color) {
            return L.divIcon({
                className: "custom-div-icon",
                html: `<div style="background-color:${color};color:white;width:20px;height:20px;border-radius:50%;text-align:center;line-height:20px;">${label}</div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
            });
        }

        function createStationIcon() {
            return L.divIcon({
                className: "station-icon",
                iconSize: [15, 15],
                iconAnchor: [7, 7],
            });
        }
        
        function updateTableRows(data, tableId, updateCount = 0) {
            const tableBody = document.getElementById(tableId).querySelector("tbody");
        
            data.forEach((row, index) => {
                let existingRow = tableBody.querySelector(`tr[data-vehicle-id="${row[0]}"]`);
        
                if (!existingRow) {
                    existingRow = document.createElement("tr");
                    existingRow.setAttribute("data-vehicle-id", row[0]);
        
                    const alphabetIdCell = document.createElement("td");
                    alphabetIdCell.textContent = alphabetIDs[index];
                    existingRow.appendChild(alphabetIdCell);
        
                    const vehicleIdCell = document.createElement("td");
                    vehicleIdCell.textContent = row[0];
                    existingRow.appendChild(vehicleIdCell);
        
                    for (let i = 0; i < 36; i++) {  // 9回分のデータ用セルに変更（4 * 9 = 36）
                        const cell = document.createElement("td");
                        existingRow.appendChild(cell);
                    }
        
                    tableBody.appendChild(existingRow);
                }
        
                const cells = existingRow.querySelectorAll("td");
                cells[updateCount * 4 + 2].textContent = row[1];  // Latitude
                cells[updateCount * 4 + 3].textContent = row[2];  // Longitude
                cells[updateCount * 4 + 4].textContent = row[3];  // Readable Date
                // cells[updateCount * 4 + 5].textContent = row[4];  // Destination
            });
        }

        async function updateMap(markerSet, tableId, isExecution = false, updateCount = 0) {
            const data = await fetchSheetData(range);
            if (!data) return;

            data.forEach((row, index) => {
                const [vehicleId, lat, lng, readableDate, destination] = row;

                if (!markerSet[vehicleId]) {
                    markerSet[vehicleId] = [];
                }

                const color = isExecution ? executionColors[updateCount % executionColors.length] : alphabetColors[index % alphabetColors.length];
                const label = isExecution ? `${(updateCount + 1) % 10}` : alphabetIDs[index] + `${(updateCount + 1) % 10}`;

                const marker = L.marker([parseFloat(lat), parseFloat(lng)], {
                    icon: createTrainIcon(label, color),
                }).addTo(map)
                  .bindPopup(`Vehicle ID: ${vehicleId}`);

                markerSet[vehicleId].push(marker);

                if (markerSet[vehicleId].length > 1) {
                    const previousMarker = markerSet[vehicleId][markerSet[vehicleId].length - 2];
                    L.polyline([
                        [previousMarker.getLatLng().lat, previousMarker.getLatLng().lng],
                        [lat, lng],
                    ], {
                        color: color,
                        weight: 4,
                        opacity: 0.8,
                    }).addTo(map);
                }

                // 更新ボタン用のテーブル更新
                updateTableRows(data, tableId, updateCount);
            });

            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleString();
        }

        async function sendRequest(vehicleId = '') {
            const requestUrl = `https://script.google.com/macros/s/AKfycbxyj7UGAD8uakopVpyk0LkAPs7IwsvCCw83gMuhUbfGH6xXezQButvvlIJeMdnfdzQlzw/exec${vehicleId ? `?vehicleID=${vehicleId}` : ''}`;
            try {
                const response = await fetch(requestUrl);
                if (response.ok) {
                    console.log('Request successful');
                } else {
                    console.error('Request failed');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById('refreshButton').addEventListener('click', async () => {
            await sendRequest();  // VehicleIDなしでリクエストを送信
            setTimeout(async () => {
                await updateMap(markers, "dataTable");  // a～zのアルファベットを使用してマーカーを表示
            }, 1000);  // 1秒待機してから地図を更新
        });

        document.getElementById('updateEvery20sButton').addEventListener('click', async () => {
            await sendRequest();
            setTimeout(async () => {
                await updateMap(markers, "dataTable", false, 0);
            }, 1000);  // 最初の更新を1秒後に行う

            // 20秒ごとに9回更新
            for (let i = 1; i < 9; i++) {
                setTimeout(async () => {
                    await sendRequest();
                    await updateMap(markers, "dataTable", false, i);
                }, i * 20000);  // 20秒ごとに実行
            }
        });

        document.getElementById('clearDataMarkersButton').addEventListener('click', () => {
            // データを更新ボタン用マーカーと矢印をすべて削除
            for (let id in markers) {
                markers[id].forEach(marker => map.removeLayer(marker));
            }
            markers = {};
        });

        document.getElementById('startButton').addEventListener('click', async () => {
            const vehicleId = document.getElementById('vehicleIdInput').value;
            if (!vehicleId) {
                alert("Vehicle IDを入力してください");
                return;
            }

            // 既存のデータを更新ボタン用マーカーをすべて削除
            for (let id in markers) {
                markers[id].forEach(marker => map.removeLayer(marker));
            }
            markers = {};

            // 既存の実行ボタン用マーカーをすべて削除
            for (let id in executionMarkers) {
                executionMarkers[id].forEach(marker => map.removeLayer(marker));
            }
            executionMarkers = {};

            // 1回目のデータ更新と取得を即時に行う
            await sendRequest(vehicleId);

            setTimeout(async () => {
                await updateMap(executionMarkers, "executionTable", true, 0);
            }, 1000);  // 1秒待機して最初のデータ取得

            // 2回目以降は20秒ごとに取得
            for (let i = 1; i < 10; i++) {
                setTimeout(async () => {
                    await sendRequest(vehicleId);
                    await updateMap(executionMarkers, "executionTable", true, i);
                }, i * 20000);  // 20秒ごとに実行
            }
        });

        document.getElementById('clearExecutionMarkersButton').addEventListener('click', () => {
            // 実行ボタン用マーカーと矢印をすべて削除
            for (let id in executionMarkers) {
                executionMarkers[id].forEach(marker => map.removeLayer(marker));
            }
            executionMarkers = {};
        });

        document.getElementById('showStationsButton').addEventListener('click', () => {
            // 既存のバス停マーカーをすべて削除
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];

            // バス停のマーカーを地図に追加
            stations.forEach(station => {
                const marker = L.marker([station.lat, station.lng], {
                    icon: createStationIcon(),
                }).addTo(map)
                  .bindPopup(station.name);

                stationMarkers.push(marker);
            });
        });

        document.getElementById('clearStationMarkersButton').addEventListener('click', () => {
            // バス停マーカーをすべて削除
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
        });

        // 運行情報ボタンのイベントリスナー
        document.getElementById('transitAlertButton').addEventListener('click', async () => {
            const alertData = await fetchTransitInfo('Alerts');
            displayTransitInfo(alertData, 'alertInfo');
        });

        // ルート更新情報ボタンのイベントリスナー
        document.getElementById('routeUpdateButton').addEventListener('click', async () => {
            const routeData = await fetchTransitInfo('TripUpdates');
            displayTransitInfo(routeData, 'routeUpdateInfo');
        });

    }

    // ページ読み込み後に初期化関数を呼び出す
    window.onload = initialize;

    </script>
</body>
</html>
