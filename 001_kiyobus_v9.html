<!DOCTYPE html> 
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Radar</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Google FontsからPoppinsフォントを読み込む -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        #map-container {
            position: relative;
            display: inline-block;
            margin-top: 10px; /* 上部に20pxの余白を追加 */
        }
        
        #map { 
            height: 610px;
            width: 610px; /* 地図のサイズを指定 */
            overflow: hidden; /* 地図の境界からはみ出る部分を隠す */
            border: none; /* 外枠を削除 */
            box-shadow: 
                0 20px 30px rgba(0, 0, 0, 0.4), /* 地図全体の下に落ちる影 */
                inset 0 10px 15px rgba(255, 255, 255, 0.5), /* 内側の光の反射による効果 */
                inset 0 -10px 20px rgba(0, 0, 0, 0.3), /* 下側の内側の影で立体感を強調 */
                inset 0 0 0 30px rgba(255, 255, 255, 0.5); /* 内側の光 */
        }

        header { 
            background: linear-gradient(135deg, #003366, #002244); /* 濃い青のグラデーション */
            color: white; /* テキストの色を白に */
            padding: 4px 4px; /* パディングを増やして余裕を持たせる */
            text-align: left; /* 左揃え */
            font-weight: 600; /* 太字 */
            font-size: 18px; /* フォントサイズを少し小さく */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2); /* ヘッダーに影を追加 */
            border-radius: 8px; /* 角を丸く */
            font-family: 'Poppins', sans-serif; /* モダンなフォントを指定 */
            max-width: 600px; /* 横幅を最大600pxに制限 */
         }
    
        header img {
            vertical-align: middle;
            width: 60px; /* 画像サイズを少し大きく */
            height: 60px;
            margin-right: 15px;
            border-radius: 50%; /* 画像も丸く */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* 画像にも影を追加 */
        }
        table { width: 100%; border-collapse: collapse; margin-top: 2px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        .station-icon {
            background-color: transparent;
            width: 20px;
            height: 20px;
            border-radius: 5px;
            border: 2px solid gray; /* 濃い灰色に修正 */
        }
        button {
            background-color: #003366; /* 濃い青の背景 */
            color: white; /* テキストの色 */
            border: none; /* ボーダーなし */
            padding: 12px 12px; /* パディングを追加 */
            text-align: center; /* テキストを中央揃え */
            text-decoration: none; /* テキストの下線なし */
            display: inline-block; /* インラインブロック要素にする */
            font-size: 12px; /* フォントサイズ */
            margin: 2px 2px; /* マージン */
            cursor: pointer; /* カーソルをポインターにする */
            border-radius: 50px; /* 丸みを帯びたボタン */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3); /* 影を追加 */
            transition: all 0.3s ease 0s; /* アニメーションの遷移を追加 */
        }   
        button:hover {
            background-color: #001a33; /* ホバー時にさらに濃い青に変更 */
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4); /* ホバー時に影を強調 */
            transform: translateY(-3px); /* ホバー時に少し上に移動する */
        }
        /* フォントサイズを小さく設定 */
        .status-text {
            font-size: 12px; /* テキスト全体を小さくする */
            display: inline; /* インライン表示に変更 */
        }
        /* 行の間にスペースを追加 */
        .status-container {
            display: inline; /* 同じ行に表示 */
        }
        /* スタイルの設定 */
        #locationStatus, #timestamp {
            font-size: 12px; /* フォントサイズを小さく設定 */
        }
        #placeInput {
            padding: 5px;
            font-size: 12px;
        }
        #dataTable, #executionTable {
            font-size: 12px; /* テーブル内の文字を12pxに設定 */
        }
        /* 見出しのフォントサイズを12pxに設定 */
        .small-heading {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <header>
        <img src="https://kickboxerj0322.github.io/bus-radar/066_アイコン.png" alt="バスレーダーアイコン" style="vertical-align: middle; width: 50px; height: 50px; margin-right: 10px;">
        Bus Radar / きよバス
    </header>
    <div id="map-container">
        <div id="north-rectangle1"></div>
        <div id="north-rectangle2"></div>
        <div id="north-rectangle3"></div>
        <div id="map"></div>
    </div>
    <div>
        <p class="status-container">
            <span class="status-text">現在位置: <span id="locationStatus">更新中...</span></span>
            &nbsp;|&nbsp; <!-- スペースと区切り線を追加 -->
            <span class="status-text">データ反映日時: <span id="timestamp">更新中...</span></span>
        </p>
    </div>
    <div>
        <button id="getCurrentLocationButton">現在位置</button>
        <input type="text" id="placeInput" placeholder="Enter location or landmark">
        <button id="setCustomLocationButton">を現在位置にする</button>
    </div>
    <div>
        <button id="refreshButton">バス</button>
        <button id="updateEvery20sButton">バス20秒×9回</button>
        <button id="stopUpdateButton">停止</button>
        <button id="clearDataMarkersButton">バス削除</button>
        <button id="showStationsButton">バス停</button>
        <button id="clearStationMarkersButton">バス停削除</button>
        <!-- <button id="transitAlertButton">運行情報</button> -->
        <!-- <button id="routeUpdateButton">ルート更新情報</button> -->
    </div>
    <div>
        <input type="text" id="vehicleIdInput" placeholder="Enter Vehicle ID">
        <button id="startButton">実行</button>
        <button id="stopstartButton">実行停止</button>
        <button id="clearExecutionMarkersButton">実行削除</button>
        <!-- <button id="stopButton">停止</button> --> <!-- 停止ボタンを追加 -->
    </div>
    <div>
        <h3 class="small-heading">バスボタンの結果</h3>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Alphabet ID</th>
                    <th>Vehicle ID</th>
                    <th>Latitude (1回目)</th>
                    <th>Longitude (1回目)</th>
                    <th>Readable Date (1回目)</th>
                    <th>Destination (1回目)</th>
                    <th>Latitude (2回目)</th>
                    <th>Longitude (2回目)</th>
                    <th>Readable Date (2回目)</th>
                    <th>Destination (2回目)</th>
                    <th>Latitude (3回目)</th>
                    <th>Longitude (3回目)</th>
                    <th>Readable Date (3回目)</th>
                    <th>Destination (3回目)</th>
                    <th>Latitude (4回目)</th>
                    <th>Longitude (4回目)</th>
                    <th>Readable Date (4回目)</th>
                    <th>Destination (4回目)</th>
                    <th>Latitude (5回目)</th>
                    <th>Longitude (5回目)</th>
                    <th>Readable Date (5回目)</th>
                    <th>Destination (5回目)</th>
                    <th>Latitude (6回目)</th>
                    <th>Longitude (6回目)</th>
                    <th>Readable Date (6回目)</th>
                    <th>Destination (6回目)</th>
                    <th>Latitude (7回目)</th>
                    <th>Longitude (7回目)</th>
                    <th>Readable Date (7回目)</th>
                    <th>Destination (7回目)</th>
                    <th>Latitude (8回目)</th>
                    <th>Longitude (8回目)</th>
                    <th>Readable Date (8回目)</th>
                    <th>Destination (8回目)</th>
                    <th>Latitude (9回目)</th>
                    <th>Longitude (9回目)</th>
                    <th>Readable Date (9回目)</th>
                    <th>Destination (9回目)</th>
                </tr>
            </thead>
            <tbody>
                <!-- データはここに追加されます（最大20行） -->
            </tbody>
        </table>
    </div>
    <div>
        <h3 class="small-heading">実行ボタンの結果</h3>
        <table id="executionTable">
            <thead>
                <tr>
                    <th>Alphabet ID</th>
                    <th>Vehicle ID</th>
                    <th>Latitude (1回目)</th>
                    <th>Longitude (1回目)</th>
                    <th>Readable Date (1回目)</th>
                    <th>Destination (1回目)</th>
                    <th>Latitude (2回目)</th>
                    <th>Longitude (2回目)</th>
                    <th>Readable Date (2回目)</th>
                    <th>Destination (2回目)</th>
                    <th>Latitude (3回目)</th>
                    <th>Longitude (3回目)</th>
                    <th>Readable Date (3回目)</th>
                    <th>Destination (3回目)</th>
                    <th>Latitude (4回目)</th>
                    <th>Longitude (4回目)</th>
                    <th>Readable Date (4回目)</th>
                    <th>Destination (4回目)</th>
                    <th>Latitude (5回目)</th>
                    <th>Longitude (5回目)</th>
                    <th>Readable Date (5回目)</th>
                    <th>Destination (5回目)</th>
                    <th>Latitude (6回目)</th>
                    <th>Longitude (6回目)</th>
                    <th>Readable Date (6回目)</th>
                    <th>Destination (6回目)</th>
                    <th>Latitude (7回目)</th>
                    <th>Longitude (7回目)</th>
                    <th>Readable Date (7回目)</th>
                    <th>Destination (7回目)</th>
                    <th>Latitude (8回目)</th>
                    <th>Longitude (8回目)</th>
                    <th>Readable Date (8回目)</th>
                    <th>Destination (8回目)</th>
                    <th>Latitude (9回目)</th>
                    <th>Longitude (9回目)</th>
                    <th>Readable Date (9回目)</th>
                    <th>Destination (9回目)</th>
                </tr>
            </thead>
            <tbody>
                <!-- データはここに追加されます -->
            </tbody>
        </table>
    </div>
    <!-- 運行情報とルート更新情報を表示するための新しいdiv要素を追加 -->
    <!-- <div>
        <h3>運行情報</h3>
        <div id="alertInfo"></div>
    </div>
    <div>
        <h3>ルート更新情報</h3>
        <div id="routeUpdateInfo"></div>
    </div> -->
    <script>

        // マーカーを3回点滅させる関数
        function blinkMarker(marker) {
            let blinkCount = 0;
            const blinkInterval = setInterval(() => {
                if (blinkCount % 2 === 0) {
                    marker.setOpacity(0); // マーカーを隠す
                } else {
                    marker.setOpacity(1); // マーカーを表示する
                }
                blinkCount++;
                if (blinkCount >= 6) { // 3回点滅させる（オンとオフを3回ずつ）
                    clearInterval(blinkInterval);
                }
            }, 200); // 0.5秒間隔で点滅
        }

        // 新しい関数を追加
        async function fetchTransitInfo(action) {
            const url = `https://script.google.com/macros/s/AKfycbyvQzZjzZ9spnqK2C6pYMxgxCn16Qlsc3PxdjgcdPRUephirrTVomVNDPAVtpnt7Z06Yw/exec?action=${action}`;
            try {
                const response = await fetch(url);
                if (response.ok) {
                    return await response.json();
                } else {
                    console.error('Request failed');
                    return null;
                }
            } catch (error) {
                console.error('Error:', error);
                return null;
            }
        }

        function displayTransitInfo(data, elementId) {
            const container = document.getElementById(elementId);
            if (!data) {
                container.innerHTML = '<p>情報の取得に失敗しました。</p>';
                return;
            }
            
            // データを整形して表示
            let html = '<table><thead><tr>';
            // ヘッダーの作成
            if (data.length > 0) {
                for (let key in data[0]) {
                    html += `<th>${key}</th>`;
                }
            }
            html += '</tr></thead><tbody>';
            
            // データ行の作成
            data.forEach(item => {
                html += '<tr>';
                for (let key in item) {
                    html += `<td>${item[key]}</td>`;
                }
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            container.innerHTML = html;
        }

        async function getApiData() {
            const response = await fetch('https://script.google.com/macros/s/AKfycbyvQzZjzZ9spnqK2C6pYMxgxCn16Qlsc3PxdjgcdPRUephirrTVomVNDPAVtpnt7Z06Yw/exec?action=getApiData');
            if (!response.ok) {
                console.error("Failed to fetch API data from GAS");
                return;
            }
            return await response.json();
        }

        let userLocationMarker;

        // グローバルスコープで map 変数を定義
        let map;
        let currentLocation = null;

        async function initialize() {
            const apiData = await getApiData();
            if (!apiData) return;

            const sheetId = apiData.sheetId;
            const range = apiData.range;
            const apiKey = apiData.apiKey;

            const map = L.map('map').setView([35.77223, 139.52046], 15);  // 清瀬駅北口を中心に表示

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            let userLocationMarker;

            // ユーザーの位置情報を取得し、地図の中心に設定し、マーカーを表示する関数
            function getCurrentLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        const { latitude, longitude } = position.coords;
                        currentLocation = { latitude, longitude };

                        // 地図の中心をユーザーの現在位置に設定
                        map.setView([latitude, longitude], 15);

                        // 既存のマーカーがあれば削除
                        if (userLocationMarker) {
                            map.removeLayer(userLocationMarker);
                        }

                        // 赤い三角形のアイコンを作成
                        const triangleIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid red;"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 20]
                        });

                        // ユーザーの現在位置にマーカーを追加
                        userLocationMarker = L.marker([latitude, longitude], { icon: triangleIcon }).addTo(map)
                            .bindPopup("現在位置");

                        // 「現在位置」の表示を更新
                        document.getElementById('locationStatus').textContent = `${latitude.toFixed(8)}/${longitude.toFixed(8)}`;

                    }, () => {
                        alert('位置情報を取得できませんでした。');
                    });
                } else {
                    alert('このブラウザでは位置情報の取得がサポートされていません。');
                }
            }

            // 現在位置ボタンのイベントリスナーを追加
            document.getElementById('getCurrentLocationButton').addEventListener('click', () => {
                // 位置情報の取得処理
                getCurrentLocation();
            
                // 音声再生の処理
                const audio = new Audio('https://kickboxerj0322.github.io/bus-radar/071_toy-button-105724.mp3');
                audio.play();
            });

            // 地名やランドマーク名から緯度・経度を取得し、現在位置に設定する関数
            async function setCustomLocation() {
                const location = document.getElementById('placeInput').value;
                if (!location) {
                    alert("地名やランドマーク名を入力してください");
                    return;
                }

                // エンコードされた地名を用いてURLを生成
                const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(location)}&key=${apiKey}`;
                try {
                    const response = await fetch(geocodeUrl);
                    const data = await response.json();
                    if (data.status === "OK") {
                        const latLng = data.results[0].geometry.location;
                        const { lat, lng } = latLng;

                        // 地図の中心を新しい位置に設定
                        map.setView([lat, lng], 15);

                        // 既存のマーカーがあれば削除
                        if (userLocationMarker) {
                            map.removeLayer(userLocationMarker);
                        }

                        // 赤い三角形のアイコンを作成
                        const triangleIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid red;"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 20]
                        });

                        // 新しい位置に赤い三角形のマーカーを追加
                        userLocationMarker = L.marker([lat, lng], { icon: triangleIcon }).addTo(map)
                            .bindPopup("指定した場所");
                        
                        // 現在位置を更新
                        currentLocation = { latitude: lat, longitude: lng };

                        // 「現在位置」の表示を更新
                        document.getElementById('locationStatus').textContent = `${lat.toFixed(8)}/${lng.toFixed(8)}`;
                    } else {
                        alert("位置情報が取得できませんでした。別の場所を試してください。");
                    }
                } catch (error) {
                    console.error("Error fetching geocode data:", error);
                    alert("エラーが発生しました。後でもう一度お試しください。");
                }
            }            

            // 特定位置ボタンのイベントリスナーを追加
            document.getElementById('setCustomLocationButton').addEventListener('click', () => {
                // 特定位置情報の取得処理
                setCustomLocation();
            
                // 音声再生の処理
                const audio = new Audio('https://kickboxerj0322.github.io/bus-radar/071_toy-button-105724.mp3');
                audio.play();
            });

        let markers = {};  // データを更新ボタン用のマーカー
        let executionMarkers = {};  // 実行ボタン用のマーカー
        let stationMarkers = [];  // バス停のマーカー
        const executionColors = ["yellow", "khaki", "tan", "orange", "mediumorchid", "cyan", "magenta", "burlywood",
            "aliceblue", "chocolate"];
        const alphabetColors = [
            "yellow", "khaki", "tan", "orange", "mediumorchid", "cyan", "magenta", "burlywood",
            "aliceblue", "chocolate", "pink", "lime", "limegreen", "lightsteelblue", "mediumorchid", "olive",
            "aqua", "peachpuff", "gray", "silver", "gold", "darkgoldenrod", "coral", "darkcyan",
            "darkorange", "forestgreen"
        ];
        const alphabetIDs = [];
        for (let i = 0; i < 500; i++) {
            let id = String.fromCharCode(97 + (i % 26));
            let prefix = Math.floor(i / 26);
            alphabetIDs.push(prefix ? String.fromCharCode(96 + prefix) + id : id);
        }

        async function fetchSheetData(range) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
            const response = await fetch(url);
            if (!response.ok) {
                console.error("Failed to fetch data from Google Sheets");
                return null;
            }
            const data = await response.json();
            return data.values || [];
        }

        const stationsSheetName = 'stations'; // バス停データ用のシート名
        const stationRange = `${stationsSheetName}!A2:C500`; // バス停データの範囲を指定（A列はname、B列はlat、C列はlng）
    
        // Google Sheetsからバス停データを取得する関数
        async function fetchStationData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${stationRange}?key=${apiKey}`;
            const response = await fetch(url);
            if (!response.ok) {
                console.error("Google Sheetsからバス停データを取得できませんでした");
                return null;
            }
            const data = await response.json();
            return data.values || []; // データが存在しない場合は空配列を返す
        }
    
        // バス停のデータを取得してマーカーを表示する関数
        async function showStations() {
            const stationData = await fetchStationData();
            if (!stationData) return;
    
            // 既存のバス停マーカーをすべて削除
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
    
            // バス停のデータを地図に追加
            stationData.forEach(station => {
                const [name, lat, lng] = station;
                const marker = L.marker([parseFloat(lat), parseFloat(lng)], {
                    icon: createStationIcon(),
                }).addTo(map)
                  .bindPopup(name);
    
                stationMarkers.push(marker);
            });
        }
    
        // バス停表示ボタンのイベントリスナーを設定
        document.getElementById('showStationsButton').addEventListener('click', showStations);
    
        // バス停削除ボタンのイベントリスナーを設定
        document.getElementById('clearStationMarkersButton').addEventListener('click', () => {
            // バス停マーカーをすべて削除
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
        });

        function createTrainIcon(label, color) {
            return L.divIcon({
                className: "custom-div-icon",
                html: `<div style="background-color:${color};color:black;width:20px;height:20px;border-radius:50%;text-align:center;line-height:20px;">${label}</div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
            });
        }

        function createStationIcon() {
            return L.divIcon({
                className: "station-icon",
                iconSize: [15, 15],
                iconAnchor: [7, 7],
            });
        }
        
        function updateTableRows(data, tableId, updateCount = 0) {
            const tableBody = document.getElementById(tableId).querySelector("tbody");
        
            data.forEach((row, index) => {
                let existingRow = tableBody.querySelector(`tr[data-vehicle-id="${row[0]}"]`);
        
                if (!existingRow) {
                    existingRow = document.createElement("tr");
                    existingRow.setAttribute("data-vehicle-id", row[0]);
        
                    const alphabetIdCell = document.createElement("td");
                    alphabetIdCell.textContent = alphabetIDs[index];
                    existingRow.appendChild(alphabetIdCell);
        
                    const vehicleIdCell = document.createElement("td");
                    vehicleIdCell.textContent = row[0];
                    existingRow.appendChild(vehicleIdCell);
        
                    for (let i = 0; i < 36; i++) {  // 9回分のデータ用セルに変更（4 * 9 = 36）
                        const cell = document.createElement("td");
                        existingRow.appendChild(cell);
                    }
        
                    tableBody.appendChild(existingRow);
                }
        
                const cells = existingRow.querySelectorAll("td");
                cells[updateCount * 4 + 2].textContent = row[1];  // Latitude
                cells[updateCount * 4 + 3].textContent = row[2];  // Longitude
                cells[updateCount * 4 + 4].textContent = row[3];  // Readable Date
                // cells[updateCount * 4 + 5].textContent = row[4];  // Destination
            });
        }

        async function updateMap(markerSet, tableId, isExecution = false, updateCount = 0) {
            const data = await fetchSheetData(range);
            if (!data) return;

            data.forEach((row, index) => {
                const [vehicleId, lat, lng, readableDate, destination] = row;

                if (!markerSet[vehicleId]) {
                    markerSet[vehicleId] = [];
                }

                const color = isExecution ? executionColors[updateCount % executionColors.length] : alphabetColors[index % alphabetColors.length];
                const label = isExecution ? `${(updateCount + 1) % 10}` : alphabetIDs[index] + `${(updateCount + 1) % 10}`;

                const marker = L.marker([parseFloat(lat), parseFloat(lng)], {
                    icon: createTrainIcon(label, color),
                }).addTo(map)
                  .bindPopup(`Vehicle ID: ${vehicleId}`);

                // マーカーが追加された際に3回点滅させる
                blinkMarker(marker);

                markerSet[vehicleId].push(marker);

                if (markerSet[vehicleId].length > 1) {
                    const previousMarker = markerSet[vehicleId][markerSet[vehicleId].length - 2];
                    L.polyline([
                        [previousMarker.getLatLng().lat, previousMarker.getLatLng().lng],
                        [lat, lng],
                    ], {
                        color: color,
                        weight: 4,
                        opacity: 0.8,
                    }).addTo(map);
                }

                // 更新ボタン用のテーブル更新
                updateTableRows(data, tableId, updateCount);
            });

            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleString();
        }

        async function sendRequest(vehicleId = '') {
            let requestUrl = `https://script.google.com/macros/s/AKfycbyvQzZjzZ9spnqK2C6pYMxgxCn16Qlsc3PxdjgcdPRUephirrTVomVNDPAVtpnt7Z06Yw/exec`;
            if (vehicleId) {
                requestUrl += `?vehicleID=${vehicleId}`;
            }
            if (currentLocation) {
                const { latitude, longitude } = currentLocation;
                requestUrl += vehicleId ? `&latitude=${latitude}&longitude=${longitude}` : `?latitude=${latitude}&longitude=${longitude}`;
            }

            try {
                const response = await fetch(requestUrl);
                if (response.ok) {
                    console.log('Request successful');
                } else {
                    console.error('Request failed');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // 音声を3回連続で再生する関数
        function playAudioThreeTimes() {
            const audio = new Audio('https://kickboxerj0322.github.io/bus-radar/072_menu-click-89198.mp3');
            let playCount = 0;  // 再生回数をカウントする変数
        
            function playNext() {
                if (playCount < 3) {
                    audio.play();
                    playCount++;  // 再生回数をカウント
                }
            }
        
            // 音声が終了したら次を再生
            audio.onended = playNext;
        
            // 最初の再生を開始
            playNext();
        }

        // 音声を再生する関数
        function playSound() {
            const audio = new Audio('https://kickboxerj0322.github.io/bus-radar/073_start-13691.mp3');
            audio.play();
        }

        document.getElementById('refreshButton').addEventListener('click', async () => {
            // 音声を再生
            playSound();
            await sendRequest();  // VehicleIDなしでリクエストを送信
            setTimeout(async () => {
                await updateMap(markers, "dataTable");  // a～zのアルファベットを使用してマーカーを表示
            }, 1000);  // 1秒待機してから地図を更新

            // 音声を3回連続で再生
            playAudioThreeTimes();
        });

        let stopUpdate = false; // 停止フラグを追加

        document.getElementById('updateEvery20sButton').addEventListener('click', async () => {
            // 音声を再生
            playSound();
            stopUpdate = false; // ボタンを押すごとに停止フラグをリセット
            await sendRequest();

            setTimeout(async () => {
                if (!stopUpdate) { // 停止フラグが立っていない場合のみ更新
                    await updateMap(markers, "dataTable", false, 0);
                    // バスの位置が更新されるたびに音声を3回連続で再生
                    playAudioThreeTimes(); 
                }
            }, 1000);  // 最初の更新を1秒後に行う

            // 20秒ごとに9回更新
            for (let i = 1; i < 9; i++) {
                setTimeout(async () => {
                    if (!stopUpdate) {
                        await sendRequest();
                        await updateMap(markers, "dataTable", false, i);
                        // バスの位置が更新されるたびに音声を3回連続で再生
                        playAudioThreeTimes();
                    }
                }, i * 20000);  // 20秒ごとに実行
            }
        });

        document.getElementById('stopUpdateButton').addEventListener('click', () => {
            stopUpdate = true; // 停止フラグを設定
            playSound(); // 停止時に音声を再生
        });

        document.getElementById('clearDataMarkersButton').addEventListener('click', () => {
            // データを更新ボタン用マーカーと矢印をすべて削除
            for (let id in markers) {
                markers[id].forEach(marker => map.removeLayer(marker));
            }
            markers = {};

            // データテーブルをクリアして初期状態に戻す
            const dataTableBody = document.getElementById('dataTable').querySelector('tbody');
            dataTableBody.innerHTML = '';            

            // 音声を再生
            playSound();

        });

        let stopstart = false; // 停止フラグを追加

        document.getElementById('startButton').addEventListener('click', async () => {
            // 音声を再生
            playSound();
            stopstart = false; // ボタンを押すごとに停止フラグをリセット
            const vehicleId = document.getElementById('vehicleIdInput').value;
            if (!vehicleId) {
                alert("Vehicle IDを入力してください");
                return;
            }
           
            // 既存のデータを更新ボタン用マーカーをすべて削除
            for (let id in markers) {
                markers[id].forEach(marker => map.removeLayer(marker));
            }
            markers = {};

            // 既存の実行ボタン用マーカーをすべて削除
            for (let id in executionMarkers) {
                executionMarkers[id].forEach(marker => map.removeLayer(marker));
            }
            executionMarkers = {};

            // 1回目のデータ更新と取得を即時に行う
            await sendRequest(vehicleId);

            setTimeout(async () => {
                if (!stopstart) { // 停止フラグが立っていない場合のみ更新
                    await updateMap(executionMarkers, "executionTable", true, 0);
                    // バスの位置が更新されるたびに音声を3回連続で再生
                    playAudioThreeTimes(); 
                }
            }, 1000);  // 1秒待機して最初のデータ取得

            // 2回目以降は20秒ごとに取得
            for (let i = 1; i < 10; i++) {
                setTimeout(async () => {
                    if (!stopstart) { // 停止フラグが立っていない場合のみ更新
                        await sendRequest(vehicleId);
                        await updateMap(executionMarkers, "executionTable", true, i);
                        // バスの位置が更新されるたびに音声を3回連続で再生
                        playAudioThreeTimes(); 
                    }
                }, i * 20000);  // 20秒ごとに実行
            }
        });

        document.getElementById('stopstartButton').addEventListener('click', () => {
            stopstart = true; // 停止フラグを設定
            playSound(); // 停止時に音声を再生
        });        

        document.getElementById('clearExecutionMarkersButton').addEventListener('click', () => {
            // 実行ボタン用マーカーと矢印をすべて削除
            for (let id in executionMarkers) {
                executionMarkers[id].forEach(marker => map.removeLayer(marker));
            }
            executionMarkers = {};

            // 実行テーブルをクリアして初期状態に戻す
            const executionTableBody = document.getElementById('executionTable').querySelector('tbody');
            executionTableBody.innerHTML = '';            

            // 音声を再生
            playSound();

        });

        document.getElementById('showStationsButton').addEventListener('click', () => {
            // 既存のバス停マーカーをすべて削除
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
            // 音声を再生
            playSound();
            // バス停のマーカーを地図に追加
            stations.forEach(station => {
                const marker = L.marker([station.lat, station.lng], {
                    icon: createStationIcon(),
                }).addTo(map)
                  .bindPopup(station.name);

                stationMarkers.push(marker);
            });
        });

        document.getElementById('clearStationMarkersButton').addEventListener('click', () => {
            // バス停マーカーをすべて削除
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];

            // 音声を再生
            playSound();

        });

        // 運行情報ボタンのイベントリスナー
        document.getElementById('transitAlertButton').addEventListener('click', async () => {
            const alertData = await fetchTransitInfo('Alerts');
            displayTransitInfo(alertData, 'alertInfo');

            // 音声を再生
            playSound();

        });

        // ルート更新情報ボタンのイベントリスナー
        document.getElementById('routeUpdateButton').addEventListener('click', async () => {
            const routeData = await fetchTransitInfo('TripUpdates');
            displayTransitInfo(routeData, 'routeUpdateInfo');

            // 音声を再生
            playSound();

        });

    }

    // ページ読み込み後に初期化関数を呼び出す
    window.onload = initialize;

    </script>
</body>
</html>
